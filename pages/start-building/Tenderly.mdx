Anyone involved in the blockchain ecosystem has likely used a gas fee estimator at some point. In this guide, we will explore how to build a gas fee estimator using Apechain and Tenderly.

## What is Apechain?

[ApeChain](https://docs.apechain.com/) is a dedicated infrastructure layer to power the ApeCoin ecosystem. ApeChain utilizes $APE as its native gas token. It focuses on high performance, scalability, and security, making it a suitable environment for developers to create robust DApps. This integration significantly enhances $APE's utility, fostering a robust and dynamic economy driven by $APE, and positioning ApeChain as a premier platform.

## What is Tenderly?

[Tenderly](https://tenderly.co/) is a Web3 development platform that provides tools for building, testing, and monitoring smart contracts on blockchain networks. It offers features like real-time debugging, transaction simulation, performance analytics, and advanced monitoring, enabling developers to improve their workflow and ensure smart contracts function correctly.

### **Understanding how the gas fee estimator will be built**

To build the gas fee estimator, we will make use of some key features of Apechain and Tenderly as listed below:

### **Apechain**

1. **RPC API for network communication**: We will use Apechain’s **RPC URL** to interact with the blockchain. This will help us with real-time interaction with the Apechain network, enabling us to retrieve accurate gas estimates and submit transactions.
2. **EVM Compatibility**: Apechain is EVM-compatible, meaning it supports the same transaction and contract interaction standards as Ethereum. This helps us leverage existing Ethereum developer ecosystems for seamless integration.

### **Tenderly**

1. [**Simulation API**](https://docs.tenderly.co/reference/api#/): Tenderly simulates transactions within Apechain’s environment, offering accurate gas usage and execution insights.
2. [**Transaction Simulation**](https://docs.tenderly.co/virtual-testnets/interact/simulate-transactions): Tenderly simulates the transaction in a controlled environment using the network's specific rules (in this case, Apechain). It mimics how the transaction would behave on-chain, including:
    - Gas limits
    - Contract calls
    - Execution logic

**Here’s the simple flow that we will follow to build the gas fee estimator:**

1. **Input transaction details**: The user provides necessary details for the transaction.
2. **Fetch gas price from Apechain**: Get the current gas price from the Apechain network.
3. **Estimate gas using Apechain RPC**: Use Apechain's RPC to estimate the gas required for the transaction.
4. **Simulate transaction on Tenderly**: Simulate the transaction on Tenderly to validate the transaction and predict potential failures.
5. **Return estimated gas fee**: Provide the user with the estimated gas fee for their transaction.

```mermaid
flowchart TD
    A[Input Transaction Details] --> B[Fetch Gas Price from Apechain]
    B --> C[Estimate Gas Using Apechain RPC]
    C --> D[Simulate Transaction on Tenderly]
    D --> E[Return Estimated Gas Fee]

```

## Getting started building

1. Sign up on [Apechain](https://apechain.com/).
2. Sign up on [Tenderly](https://tenderly.co/).
3. Get the Tenderly account slug and project slug as mentioned in the guide [here.](https://docs.tenderly.co/account/projects/account-project-slug)
4. You’ll need the following libraries to interact with Apechain, Tenderly, and handle gas estimation:
    
    ```bash
    npm install ethers axios dotenv
    ```
    
5. Add the Tenderly API key and Apechain URL in a `.env` file as shown below:
    
    ```makefile
    APECHAIN_RPC_URL=your_apechain_rpc_url_here
    TENDERLY_API_KEY=your_tenderly_api_key_here
    ```
    
6. Create a new `gasEstimator.js` file and the following code:
    
    ```jsx
    require('dotenv').config();
    const { ethers } = require('ethers');
    const axios = require('axios');
    
    // Apechain RPC URL and Tenderly API key from .env
    const APECHAIN_RPC_URL = process.env.APECHAIN_RPC_URL;
    const TENDERLY_API_KEY = process.env.TENDERLY_API_KEY;
    
    // Set up Apechain provider
    const provider = new ethers.JsonRpcProvider(APECHAIN_RPC_URL);
    
    // Function to estimate gas
    async function estimateGas(transaction) {
      try {
        const gasEstimate = await provider.estimateGas(transaction);
        console.log(`Estimated Gas: ${gasEstimate.toString()}`);
        return gasEstimate;
      } catch (error) {
        console.error('Error estimating gas:', error);
      }
    }
    
    // Function to simulate transaction on Tenderly
    async function simulateTransaction(transaction) {
      try {
        const response = await axios.post(
          `https://api.tenderly.co/api/v1/account/ethereum/simulate`,
          {
            transaction,
          },
          {
            headers: {
              'Authorization': `Bearer ${TENDERLY_API_KEY}`,
            },
          }
        );
    
        console.log('Simulation Result:', response.data);
        return response.data;
      } catch (error) {
        console.error('Error simulating transaction on Tenderly:', error);
      }
    }
    
    // Example usage: Estimate gas and simulate transaction
    async function main() {
      const transaction = {
        to: '0xRecipientAddressHere',
        value: ethers.utils.parseEther('0.1'), // 0.1 ETH
        data: '0x', // Optional: Contract call data
      };
    
      const gasEstimate = await estimateGas(transaction);
      await simulateTransaction(transaction);
    }
    
    main();
    ```
    
7. Run the script to estimate gas and stimulate a transaction:
    
    ```bash
    node gasEstimator.js
    ```